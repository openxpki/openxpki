<!-- Generated by "tools/scripts/ogflow.pl " -->


<workflow>
    <type>I18N_OPENXPKI_WF_TYPE_SMARTCARD_PERSONALIZATION_V4</type>
    <description>I18N_OPENXPKI_WF_DESC_SMARTCARD_PERSONALIZATION_V4</description>
    <persister>OpenXPKI</persister>

    <state name="INITIAL">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_INITIAL</description>
        <action name="scpers_initialize" resulting_state="INITIALIZED">
        </action>
    </state>

    <state name="PRE_SUCCESS"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PRE_SUCCESS</description>
        <action name="scpers_null1" resulting_state="CERT_UNPUB_CHECK">
        </action>
    </state>

    <state name="PREPARE_ESCROW_CERT_INSTALLATION"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PREPARE_ESCROW_CERT_INSTALLATION</description>
        <action name="scpers_create_pkcs12_password" resulting_state="PKCS12_PASSWORD_ENCRYPTED">
        </action>
    </state>

    <state name="KEY_ESCROWED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_KEY_ESCROWED</description>
        <action name="scpers_create_pkcs12" resulting_state="PKCS12_CREATED">
        </action>
    </state>

    <state name="NEW_ESCROW_CERT_ISSUED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_NEW_ESCROW_CERT_ISSUED</description>
        <action name="scpers_rename_key" resulting_state="PRIVATE_KEY_RENAMED">
        </action>
    </state>

    <state name="FAILURE">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_FAILURE</description>
    </state>

    <state name="SUCCESS">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_SUCCESS</description>
    </state>

    <state name="CERTIFICATE_ISSUANCE_POSSIBLE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERTIFICATE_ISSUANCE_POSSIBLE</description>
        <action name="scpers_null1" resulting_state="NEED_PUK">
            <condition name="scpers_need_random_PIN"/>
            <condition name="scpers_will_need_PIN"/>
        </action>
        <action name="scpers_null2" resulting_state="PIN_MISSING">
            <condition name="!scpers_need_random_PIN"/>
            <condition name="scpers_will_need_PIN"/>
        </action>
        <action name="scpers_null3" resulting_state="PIN_CONTINUE">
            <condition name="!scpers_will_need_PIN"/>
        </action>
    </state>

    <state name="INITIALIZED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_INITIALIZED</description>
        <action name="scpers_check_prereqs_via_api" resulting_state="PREREQS_AVAILABLE">
        </action>
    </state>

    <state name="HAVE_PUK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_PUK</description>
        <action name="scpers_null1" resulting_state="START_ACTIONS">
        </action>
    </state>

    <state name="CERT_PUBLISH_CHECK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_PUBLISH_CHECK</description>
        <action name="scpers_queue_certs_for_publication" resulting_state="CERTS_QUEUED_FOR_PUBLICATION">
        </action>
    </state>

    <state name="CERT_DELETE_CHECK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_DELETE_CHECK</description>
        <action name="scpers_queue_certs_to_delete" resulting_state="CERTS_QUEUED_FOR_DELETION">
        </action>
    </state>

    <state name="CERT_INST_CHECK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_INST_CHECK</description>
        <action name="scpers_null1" resulting_state="WHICH_CERT_TO_INSTALL">
            <condition name="!scpers_all_certs_installed"/>
        </action>
        <action name="scpers_null2" resulting_state="INSTALL_CERTIFICATE_DONE">
            <condition name="scpers_all_certs_installed"/>
        </action>
    </state>

    <state name="HAVE_PREREQS"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_PREREQS</description>
        <action name="scpers_null1" resulting_state="CERTIFICATE_ISSUANCE_POSSIBLE">
            <condition name="scpers_smartcard_status_activated"/>
        </action>
        <action name="scpers_null2" resulting_state="CERTIFICATE_ISSUANCE_POSSIBLE">
            <condition name="scpers_is_badge_officer"/>
            <condition name="scpers_smartcard_status_initial"/>
            <condition name="!scpers_smartcard_status_activated"/>
        </action>
        <action name="scpers_auth_err" resulting_state="FAILURE">
            <condition name="!scpers_is_badge_officer"/>
            <condition name="scpers_smartcard_status_initial"/>
            <condition name="!scpers_smartcard_status_activated"/>
        </action>
        <action name="scpers_status_err" resulting_state="FAILURE">
            <condition name="!scpers_smartcard_status_initial"/>
            <condition name="!scpers_smartcard_status_activated"/>
        </action>
    </state>

    <state name="HAVE_WRITABLE_PUK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_WRITABLE_PUK</description>
        <action name="scpers_generate_puk" resulting_state="HAVE_GENERATED_PUK">
        </action>
    </state>

    <state name="NEED_NON_ESCROW_CSR">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_NEED_NON_ESCROW_CSR</description>
        <action name="scpers_post_non_escrow_csr_err" resulting_state="NEED_NON_ESCROW_CSR">
        </action>
        <action name="scpers_fetch_puk" resulting_state="NEED_NON_ESCROW_CSR">
        </action>
        <action name="scpers_fail_workflow" resulting_state="FAILURE">
        </action>
        <action name="scpers_post_non_escrow_csr" resulting_state="CSR_AVAIL">
        </action>
    </state>

    <state name="START_ACTIONS"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_START_ACTIONS</description>
        <action name="scpers_null1" resulting_state="PREP_LOOP_NEED_CSR">
        </action>
    </state>

    <state name="NEED_PUK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_NEED_PUK</description>
        <action name="scpers_null1" resulting_state="HAVE_PUK">
            <condition name="scpers_puk_found_in_datapool"/>
        </action>
        <action name="scpers_null2" resulting_state="NO_STORED_PUK_AVAIL">
            <condition name="!scpers_puk_found_in_datapool"/>
        </action>
    </state>

    <state name="PUK_TO_INSTALL">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PUK_TO_INSTALL</description>
        <action name="scpers_fail_workflow" resulting_state="FAILURE">
        </action>
        <action name="scpers_puk_write_err" resulting_state="PUK_TO_INSTALL">
        </action>
        <action name="scpers_fetch_puk" resulting_state="PUK_TO_INSTALL">
        </action>
        <action name="scpers_puk_write_ok" resulting_state="HAVE_PUK">
        </action>
    </state>

    <state name="APPROVAL"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_APPROVAL</description>
        <action name="scpers_approve_wf" resulting_state="all_approvals_present">
        </action>
        <action name="scpers_reject_wf" resulting_state="FAILURE">
        </action>
    </state>

    <state name="CERT_TO_PUBLISH"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_TO_PUBLISH</description>
        <action name="scpers_next_cert_to_publish" resulting_state="CERT_ID_TO_PUBLISH">
        </action>
    </state>

    <state name="CERT_TO_DELETE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_TO_DELETE</description>
        <action name="scpers_next_cert_to_delete" resulting_state="HAVE_CERT_TO_DELETE">
        </action>
    </state>

    <state name="WHICH_CERT_TO_INSTALL"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_WHICH_CERT_TO_INSTALL</description>
        <action name="scpers_fetch_cert_id_to_install" resulting_state="FETCH_CERTIFICATE">
        </action>
    </state>

    <state name="CSR_AVAIL"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CSR_AVAIL</description>
        <action name="scpers_apply_csr_policy" resulting_state="QUEUE_CSR_TO_ISSUE">
        </action>
    </state>

    <state name="CERT_UNPUB_CHECK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_UNPUB_CHECK</description>
        <action name="scpers_queue_certs_to_unpublish" resulting_state="CERTS_QUEUED_FOR_DEPUBLICATION">
        </action>
    </state>

    <state name="HAVE_CERT_TO_UNPUBLISH"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_CERT_TO_UNPUBLISH</description>
        <action name="scpers_unpublish_certificate" resulting_state="CERTS_QUEUED_FOR_DEPUBLICATION">
        </action>
    </state>

    <state name="NO_STORED_PUK_AVAIL"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_NO_STORED_PUK_AVAIL</description>
        <action name="scpers_compute_puk" resulting_state="HAVE_COMPUTED_PUK">
        </action>
    </state>

    <state name="PRE_ISSUANCE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PRE_ISSUANCE</description>
        <action name="scpers_null1" resulting_state="CSRS_TO_PROCESS">
            <condition name="scpers_csrs_to_process"/>
        </action>
        <action name="scpers_null2" resulting_state="CERTIFICATE_ISSUANCE_DONE">
            <condition name="!scpers_csrs_to_process"/>
        </action>
    </state>

    <state name="HAVE_CERT_TO_PUBLISH"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_CERT_TO_PUBLISH</description>
        <action name="scpers_publish_certificate" resulting_state="CERTS_QUEUED_FOR_PUBLICATION">
        </action>
    </state>

    <state name="HAVE_GENERATED_PUK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_GENERATED_PUK</description>
        <action name="scpers_null1" resulting_state="PUK_TO_INSTALL">
            <condition name="scpers_generated_puk_ok"/>
        </action>
        <action name="scpers_null2" resulting_state="FAILURE">
            <condition name="!scpers_generated_puk_ok"/>
        </action>
    </state>

    <state name="PIN_MISSING">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PIN_MISSING</description>
        <action name="scpers_fail_workflow" resulting_state="FAILURE">
        </action>
        <action name="scpers_gui_has_pin" resulting_state="PIN_CONTINUE">
        </action>
        <action name="scpers_user_abort" resulting_state="FAILURE">
        </action>
    </state>

    <state name="CERT_TO_INSTALL">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_TO_INSTALL</description>
        <action name="scpers_cert_inst_err" resulting_state="CERT_TO_INSTALL">
        </action>
        <action name="scpers_fetch_puk" resulting_state="CERT_TO_INSTALL">
        </action>
        <action name="scpers_cert_inst_ok" resulting_state="CERT_INST_CHECK">
        </action>
        <action name="scpers_fail_workflow" resulting_state="FAILURE">
        </action>
    </state>

    <state name="ISSUE_CERT"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_ISSUE_CERT</description>
        <action name="scpers_issue_certificate" resulting_state="CERT_ISSUED">
        </action>
    </state>

    <state name="PIN_CONTINUE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PIN_CONTINUE</description>
        <action name="scpers_null1" resulting_state="START_ACTIONS">
        </action>
    </state>

    <state name="CERTS_QUEUED_FOR_PUBLICATION"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERTS_QUEUED_FOR_PUBLICATION</description>
        <action name="scpers_null1" resulting_state="CERT_TO_PUBLISH">
            <condition name="!scpers_all_certs_published"/>
        </action>
        <action name="scpers_null2" resulting_state="CERTS_PUBLISHED">
            <condition name="scpers_all_certs_published"/>
        </action>
    </state>

    <state name="CERTS_QUEUED_FOR_DELETION"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERTS_QUEUED_FOR_DELETION</description>
        <action name="scpers_null1" resulting_state="CERT_TO_DELETE">
            <condition name="!scpers_all_certs_deleted"/>
        </action>
        <action name="scpers_null2" resulting_state="CERTS_DELETED">
            <condition name="scpers_all_certs_deleted"/>
        </action>
    </state>

    <state name="CERTS_QUEUED_FOR_DEPUBLICATION"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERTS_QUEUED_FOR_DEPUBLICATION</description>
        <action name="scpers_null1" resulting_state="CERT_DELETE_CHECK">
            <condition name="scpers_all_certs_unpublished"/>
        </action>
        <action name="scpers_null2" resulting_state="CERT_TO_UNPUBLISH">
            <condition name="!scpers_all_certs_unpublished"/>
        </action>
    </state>

    <state name="HAVE_CERT_TO_DELETE">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_CERT_TO_DELETE</description>
        <action name="scpers_fail_workflow" resulting_state="FAILURE">
        </action>
        <action name="scpers_fetch_puk" resulting_state="HAVE_CERT_TO_DELETE">
        </action>
        <action name="scpers_cert_del_ok" resulting_state="CERTS_QUEUED_FOR_DELETION">
        </action>
        <action name="scpers_cert_del_err" resulting_state="HAVE_CERT_TO_DELETE">
        </action>
    </state>

    <state name="CAN_ISSUE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CAN_ISSUE</description>
        <action name="scpers_null1" resulting_state="NEXT_CSR_TO_ISSUE">
            <condition name="!scpers_all_certs_issued"/>
        </action>
        <action name="scpers_null2" resulting_state="CERTIFICATE_ISSUANCE_DONE">
            <condition name="scpers_all_certs_issued"/>
        </action>
    </state>

    <state name="INSTALL_CERTIFICATE_DONE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_INSTALL_CERTIFICATE_DONE</description>
        <action name="scpers_null1" resulting_state="CERT_PUBLISH_CHECK">
        </action>
    </state>

    <state name="PREPARE_CERT_INST"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PREPARE_CERT_INST</description>
        <action name="scpers_queue_issued_certs_for_installation" resulting_state="QUEUE_CERTS_TO_RECOVER">
        </action>
    </state>

    <state name="CERTS_PUBLISHED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERTS_PUBLISHED</description>
        <action name="scpers_null1" resulting_state="PRE_SUCCESS">
        </action>
    </state>

    <state name="PERSIST_CSRS"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PERSIST_CSRS</description>
        <action name="scpers_persist_csrs" resulting_state="PREPARE_CSRS_TO_PROCESS">
        </action>
    </state>

    <state name="CERT_TO_UNPUBLISH"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_TO_UNPUBLISH</description>
        <action name="scpers_next_cert_to_unpublish" resulting_state="HAVE_CERT_TO_UNPUBLISH">
        </action>
    </state>

    <state name="CERT_ISSUED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_ISSUED</description>
        <action name="scpers_null1" resulting_state="NEW_ESCROW_CERT_ISSUED">
            <condition name="scpers_has_escrow_key_to_rename"/>
        </action>
        <action name="scpers_null2" resulting_state="CAN_ISSUE">
            <condition name="!scpers_has_escrow_key_to_rename"/>
        </action>
    </state>

    <state name="PREPARE_CSRS_TO_PROCESS"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PREPARE_CSRS_TO_PROCESS</description>
        <action name="scpers_copy_csr_serials" resulting_state="CAN_ISSUE">
        </action>
    </state>

    <state name="PRIVATE_KEY_RENAMED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PRIVATE_KEY_RENAMED</description>
        <action name="scpers_add_escrow_cert_to_publish_queue" resulting_state="CAN_ISSUE">
        </action>
    </state>

    <state name="FETCH_CERTIFICATE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_FETCH_CERTIFICATE</description>
        <action name="scpers_fetch_certificate" resulting_state="CERT_RETRIEVED">
        </action>
    </state>

    <state name="NEXT_CSR_TO_ISSUE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_NEXT_CSR_TO_ISSUE</description>
        <action name="scpers_next_csr_to_issue" resulting_state="ISSUE_CERT">
        </action>
    </state>

    <state name="CERT_RETRIEVED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_RETRIEVED</description>
        <action name="scpers_calculate_key_id" resulting_state="KEY_ID_COMPUTED">
        </action>
    </state>

    <state name="ESCROW_CERT_TO_INSTALL"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_ESCROW_CERT_TO_INSTALL</description>
        <action name="scpers_null1" resulting_state="CERT_INST_CHECK">
            <condition name="!scpers_private_key_exists_in_datapool"/>
        </action>
        <action name="scpers_null2" resulting_state="PKCS12_TO_INSTALL">
            <condition name="scpers_private_key_exists_in_datapool"/>
        </action>
    </state>

    <state name="CSR_DONE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CSR_DONE</description>
        <action name="scpers_null1" resulting_state="PRE_ISSUANCE">
        </action>
    </state>

    <state name="CERTIFICATE_ISSUANCE_DONE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERTIFICATE_ISSUANCE_DONE</description>
        <action name="scpers_null1" resulting_state="PREPARE_CERT_INST">
        </action>
    </state>

    <state name="X509_PREPARED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_X509_PREPARED</description>
        <action name="scpers_set_cert_type_to_x509" resulting_state="CERT_TO_INSTALL">
        </action>
    </state>

    <state name="PKCS12_PARAMETERS_SET"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PKCS12_PARAMETERS_SET</description>
        <action name="scpers_escrow_private_key" resulting_state="KEY_ESCROWED">
        </action>
    </state>

    <state name="PKCS12_TO_INSTALL">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PKCS12_TO_INSTALL</description>
        <action name="scpers_cert_inst_err" resulting_state="PKCS12_TO_INSTALL">
        </action>
        <action name="scpers_refetch_p12" resulting_state="PREPARE_ESCROW_CERT_INSTALLATION">
        </action>
        <action name="scpers_fetch_puk" resulting_state="PKCS12_TO_INSTALL">
        </action>
        <action name="scpers_fail_workflow" resulting_state="FAILURE">
        </action>
        <action name="scpers_cert_inst_ok" resulting_state="CERT_INST_CHECK">
        </action>
    </state>

    <state name="PREREQS_AVAILABLE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PREREQS_AVAILABLE</description>
        <action name="scpers_set_workflow_creator" resulting_state="OWNER_IDENTIFIED">
        </action>
    </state>

    <state name="OWNER_IDENTIFIED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_OWNER_IDENTIFIED</description>
        <action name="scpers_null1" resulting_state="HAVE_PREREQS">
        </action>
    </state>

    <state name="QUEUE_CERTS_TO_RECOVER"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_QUEUE_CERTS_TO_RECOVER</description>
        <action name="scpers_queue_certs_to_recover_for_installation" resulting_state="CERT_INST_CHECK">
        </action>
    </state>

    <state name="CERT_ID_TO_PUBLISH"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERT_ID_TO_PUBLISH</description>
        <action name="scpers_fetch_certificate" resulting_state="HAVE_CERT_TO_PUBLISH">
        </action>
    </state>

    <state name="KEY_ID_COMPUTED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_KEY_ID_COMPUTED</description>
        <action name="scpers_null1" resulting_state="X509_PREPARED">
            <condition name="!scpers_is_escrow_cert"/>
        </action>
        <action name="scpers_null2" resulting_state="ESCROW_CERT_TO_INSTALL">
            <condition name="scpers_is_escrow_cert"/>
        </action>
    </state>

    <state name="PREP_LOOP_NEED_CSR"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PREP_LOOP_NEED_CSR</description>
        <action name="scpers_init_tmp_list_csr" resulting_state="BEGIN_LOOP_NEED_CSR">
        </action>
    </state>

    <state name="CERTS_DELETED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CERTS_DELETED</description>
        <action name="scpers_cleanup_workflow" resulting_state="SUCCESS">
        </action>
    </state>

    <state name="BEGIN_LOOP_NEED_CSR"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_BEGIN_LOOP_NEED_CSR</description>
        <action name="scpers_null1" resulting_state="GET_NEXT_NEED_CSR">
            <condition name="!scpers_temp_list_empty"/>
        </action>
        <action name="scpers_null2" resulting_state="CSR_DONE">
            <condition name="scpers_temp_list_empty"/>
        </action>
    </state>

    <state name="GET_NEXT_NEED_CSR"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_GET_NEXT_NEED_CSR</description>
        <action name="scpers_get_next_need_csr" resulting_state="HAVE_NEXT_NEED_CSR">
        </action>
    </state>

    <state name="QUEUE_CSR_TO_ISSUE"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_QUEUE_CSR_TO_ISSUE</description>
        <action name="scpers_queue_csr_to_issue" resulting_state="BEGIN_LOOP_NEED_CSR">
            <condition name="!scpers_policy_input_required"/>
        </action>
        <action name="scpers_null1" resulting_state="POLICY_INPUT_REQUIRED">
            <condition name="scpers_policy_input_required"/>
        </action>
    </state>

    <state name="HAVE_COMPUTED_PUK"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_COMPUTED_PUK</description>
        <action name="scpers_null1" resulting_state="HAVE_WRITABLE_PUK">
            <condition name="scpers_can_set_puk"/>
        </action>
        <action name="scpers_null2" resulting_state="FAILURE">
            <condition name="!scpers_can_set_puk"/>
        </action>
    </state>

    <state name="CSRS_TO_PROCESS"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_CSRS_TO_PROCESS</description>
        <action name="scpers_null1" resulting_state="APPROVAL">
            <condition name="scpers_workflow_approval_needed"/>
        </action>
        <action name="scpers_null2" resulting_state="PERSIST_CSRS">
            <condition name="!scpers_workflow_approval_needed"/>
        </action>
    </state>

    <state name="PKCS12_PASSWORD_ENCRYPTED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PKCS12_PASSWORD_ENCRYPTED</description>
        <action name="scpers_set_p12_parameters" resulting_state="PKCS12_PARAMETERS_SET">
        </action>
    </state>

    <state name="NEED_ESCROW_CSR"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_NEED_ESCROW_CSR</description>
        <action name="scpers_create_escrow_csr" resulting_state="CSR_AVAIL">
        </action>
    </state>

    <state name="PKCS12_CREATED"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_PKCS12_CREATED</description>
        <action name="scpers_clear_passwords" resulting_state="PKCS12_TO_INSTALL">
        </action>
    </state>

    <state name="NEED_ESCROW_KEY"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_NEED_ESCROW_KEY</description>
        <action name="scpers_create_escrowed_key" resulting_state="NEED_ESCROW_CSR">
        </action>
    </state>

    <state name="HAVE_NEXT_NEED_CSR"
            autorun="yes">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_HAVE_NEXT_NEED_CSR</description>
        <action name="scpers_null1" resulting_state="NEED_ESCROW_KEY">
            <condition name="scpers_is_escrow_csr"/>
        </action>
        <action name="scpers_null2" resulting_state="NEED_NON_ESCROW_CSR">
            <condition name="!scpers_is_escrow_csr"/>
        </action>
    </state>

    <state name="POLICY_INPUT_REQUIRED">
        <description>I18N_OPENXPKI_WF_STATE_SMARTCARD_PERSONALIZATION_V4_POLICY_INPUT_REQUIRED</description>
        <action name="scpers_apply_csr_policy" resulting_state="QUEUE_CSR_TO_ISSUE">
        </action>
    </state>

</workflow>
